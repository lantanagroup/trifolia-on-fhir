<h1>Audit Log</h1>

<ng-container *ngIf="audits">
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th class="col-1">Raw</th>
        <th class="col-3 clickable" (click)="changeSort('timestamp')">Time <i title="Sort by timestamp" [ngClass]="getSortIcon('timestamp')"></i></th>
        <th class="col-1 clickable" (click)="changeSort('action')">Action <i title="Sort by action" [ngClass]="getSortIcon('action')"></i></th>
        <th class="col-2 clickable" (click)="changeSort('entityType')">Entity Type <i title="Sort by entity type" [ngClass]="getSortIcon('entityType')"></i></th>
        <th class="col-2 clickable" (click)="changeSort('fhirResource.resource.resourceType')">FHIR Resource Type <i title="Sort by resource type" [ngClass]="getSortIcon('fhirResource.resource.resourceType')"></i></th>
        <th class="col-3 clickable" (click)="changeSort('user.lastName,user.firstName')">User <i title="Sort by user" [ngClass]="getSortIcon('user.lastName,user.firstName')"></i></th>
      </tr>
      <tr>
        <th></th>
        <th>
          <div class="row row-cols">
            <div class="col-6">
              <div class="dp-hidden position-absolute">
                <div class="input-group">
                  <input name="datepicker" class="form-control" ngbDatepicker #datepicker="ngbDatepicker" [autoClose]="'outside'"
                    (dateSelect)="onDateSelection($event)" [displayMonths]="2" [dayTemplate]="t" outsideDays="hidden"
                    [startDate]="fromDate!" />
                  <ng-template #t let-date let-focused="focused">
                    <span class="custom-day" [class.focused]="focused" [class.range]="isRange(date)"
                      [class.faded]="isHovered(date) || isInside(date)" (mouseenter)="hoveredDate = date"
                      (mouseleave)="hoveredDate = null">
                      {{ date.day }}
                    </span>
                  </ng-template>
                </div>
              </div>
              <div class="input-group">
                <input #dpFromDate class="form-control" placeholder="yyyy-mm-dd" name="dpFromDate"
                  [value]="formatter.format(fromDate)"
                  (input)="fromDate = validateDateInput(fromDate, dpFromDate.value)" />
                <button type="button" class="btn btn-primary fa fa-times" (click)="fromDate=null"></button>
                <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
              </div>
            </div>
            <div class="col-6">
              <div class="input-group">
                <input #dpToDate class="form-control" placeholder="yyyy-mm-dd" name="dpToDate" [value]="formatter.format(toDate)"
                  (input)="toDate = validateDateInput(toDate, dpToDate.value)" />
                <button type="button" class="btn btn-primary fa fa-times" (click)="toDate=null"></button>
                <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
              </div>
            </div>
          </div>
        </th>
        <th>
          <select class="form-control" [(ngModel)]="criteria.action" (ngModelChange)="criteriaChangedEvent.next()">
            <option value="">All</option>
            <option *ngFor="let action of actions" [value]="action">{{ action }}</option>
          </select>
        </th>
        <th>
          <select class="form-control" [(ngModel)]="criteria.entityType" (ngModelChange)="criteriaChangedEvent.next()">
            <option value="">All</option>
            <option *ngFor="let entityType of entityTypes" [value]="entityType">{{ entityType }}</option>
          </select>
        </th>
        <th>
          <input type="text" class="form-control" [(ngModel)]="criteria.fhirResourceType" (ngModelChange)="criteriaChangedEvent.next()" />
        </th>
        <th>
          <input type="text" class="form-control" [(ngModel)]="criteria.user" (ngModelChange)="criteriaChangedEvent.next()" />
        </th>
      </tr>
    </thead>
    <tbody *ngIf="audits.total > 0">
      <tr *ngFor="let audit of audits.results">
        <td>
          <button type="button" class="btn btn-primary btn-sm" title="View raw audit" (click)="openAuditModal(auditModal, audit)">
            <i class="fa fa-search"></i>
          </button>
        </td>
        <td>{{ audit.timestamp | date:'medium' }}</td>
        <td>
          {{ audit.action }}
          <button *ngIf="audit.action === AuditAction.Update" type="button" class="btn btn-primary btn-sm pull-right" title="View changes" (click)="openDiffsModal(diffsModal, audit.propertyDiffs)">
            <i class="fa fa-exchange-alt"></i>
          </button>
        </td>
        <td>
          {{ audit.entityType }}
          <button *ngIf="!!audit.entityValue" type="button" class="btn btn-primary btn-sm pull-right" title="View raw entity" (click)="openEntityModal(entityModal, audit.entityValue)">
            <i class="fa fa-search"></i>
          </button>
        </td>
        <td>
          <ng-container *ngIf="audit.entityType === AuditEntityType.FhirResource && !!audit.entityValue?.resource?.resourceType">
            {{ audit.entityValue.resource.resourceType }}
          </ng-container>
        </td>
        <td>
          <ng-container *ngIf="audit.user">
            {{ audit.user.firstName }} {{ audit.user.lastName }}
            <button type="button" class="btn btn-primary btn-sm pull-right" title="View raw user" (click)="openUserModal(userModal, audit.user)">
              <i class="fa fa-user-circle"></i>
            </button>
          </ng-container>
        </td>
      </tr>
    </tbody>
    <tbody *ngIf="!loadingResults && audits.total === 0">
      <tr>
        <td colspan="6" class="text-center">No audits found matching the search criteria!</td>
      </tr>
    </tbody>
    <tbody *ngIf="loadingResults">
      <tr>
        <td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading audit logs</td>
      </tr>
    </tbody>
  </table>
  <div class="d-flex justify-content-between" *ngIf="audits.total > 0" >
    
    <div>
      Total: {{ audits.total }}
    </div>

    <ngb-pagination class="d-flex justify-content-center" [pageSize]="audits.itemsPerPage" [collectionSize]="audits.total"
      [(page)]="currentPage" [boundaryLinks]="true" (pageChange)="getAudits()">
    </ngb-pagination>

    <div>
      <select id="itemsPerPage" class="form-select" [(ngModel)]="itemsPerPage" (ngModelChange)="criteriaChangedEvent.next()">
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
        <option [value]="100">100</option>
      </select>
    </div>
  </div>
</ng-container>


<ng-template #auditModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">View Audit</h4>
    <button type="button" class="btn" aria-label="Copy to clipboard" title="Copy to clipboard" (click)="copyToClipboard(currentAudit)">
      <i class="fa fa-copy"></i>
    </button>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body" *ngIf="currentAudit">
    <pre>{{ currentAudit | json }}</pre>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Close</button>
  </div>
</ng-template>

<ng-template #entityModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">View Resource</h4>
    <button type="button" class="btn" aria-label="Copy to clipboard" title="Copy to clipboard" (click)="copyToClipboard(currentEntity)">
      <i class="fa fa-copy"></i>
    </button>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body" *ngIf="currentEntity">
    <pre>{{ currentEntity | json }}</pre>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Close</button>
  </div>
</ng-template>


<ng-template #userModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">View User</h4>
    <button type="button" class="btn" aria-label="Copy to clipboard" title="Copy to clipboard" (click)="copyToClipboard(currentUser)">
      <i class="fa fa-copy"></i>
    </button>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body" *ngIf="currentUser">
    <pre>{{ currentUser | json }}</pre>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Close</button>
  </div>
</ng-template>


<ng-template #diffsModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">View Changes</h4>
    <button type="button" class="btn" aria-label="Copy to clipboard" title="Copy to clipboard" (click)="copyToClipboard(currentPropertyDiffs)">
      <i class="fa fa-copy"></i>
    </button>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body" *ngIf="currentPropertyDiffs">

    <ul ngbNav #nav="ngbNav" class="nav-tabs">
      <li ngbNavItem>
        <a ngbNavLink>List</a>
        <ng-template ngbNavContent>
          <table class="table">
            <thead>
              <tr>
                <th>Old Value</th>
                <th>New Value</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let diff of currentPropertyDiffs">
                <tr>
                  <td colspan="2">{{ diff.path }}</td>
                </tr>
                <tr>
                  <td>
                    <pre>{{ diff.oldValue | json }}</pre>
                  </td>
                  <td>
                    <pre>{{ diff.newValue | json }}</pre>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </ng-template>
      </li>
      <li ngbNavItem>
        <a ngbNavLink>Raw</a>
        <ng-template ngbNavContent>
          <pre>{{ currentPropertyDiffs | json }}</pre>
        </ng-template>
      </li>
    </ul>
    <div [ngbNavOutlet]="nav"></div>

  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Close</button>
  </div>
</ng-template>