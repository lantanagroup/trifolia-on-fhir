<div>
  <label>Audit Reports</label>
  <select class="form-select" [(ngModel)]="reportType" (ngModelChange)="criteriaChangedEvent.next()">
    <option value=""></option>
    <option value="igReport">Accessed Igs</option>
    <option value="fhirResourceReport">Accessed Fhir Resources</option>
    <option value="usersReport">Users</option>
  </select>
</div>

<ng-container *ngIf="audits">
  <table *ngIf = "reportType == 'igReport'" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th class="col-1"></th>
        <th class="col-3">Time</th>
      </tr>
      <tr>
        <th></th>
        <th>
          <div class="row row-cols">
            <div class="col-6">
              <div class="dp-hidden position-absolute">
                <div class="input-group">
                  <input name="datepicker" class="form-control" ngbDatepicker #datepicker="ngbDatepicker" [autoClose]="'outside'"
                    (dateSelect)="onDateSelection($event)" [displayMonths]="2" [dayTemplate]="t" outsideDays="hidden"
                    [startDate]="fromDate!" />
                  <ng-template #t let-date let-focused="focused">
                    <span class="custom-day" [class.focused]="focused" [class.range]="isRange(date)"
                      [class.faded]="isHovered(date) || isInside(date)" (mouseenter)="hoveredDate = date"
                      (mouseleave)="hoveredDate = null">
                      {{ date.day }}
                    </span>
                  </ng-template>
                </div>
              </div>
              <div class="input-group">
                <input #dpFromDate class="form-control" placeholder="yyyy-mm-dd" name="dpFromDate"
                  [value]="formatter.format(fromDate)"
                  (input)="fromDate = validateDateInput(fromDate, dpFromDate.value)" />
                <button type="button" class="btn btn-primary fa fa-times" (click)="fromDate=null"></button>
                <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
              </div>
            </div>
            <div class="col-6">
              <div class="input-group">
                <input #dpToDate class="form-control" placeholder="yyyy-mm-dd" name="dpToDate" [value]="formatter.format(toDate)"
                  (input)="toDate = validateDateInput(toDate, dpToDate.value)" />
                <button type="button" class="btn btn-primary fa fa-times" (click)="toDate=null"></button>
                <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
              </div>
            </div>
          </div>
        </th>

      </tr>
      <tr>
        <th class="col-1">Resource Type</th>
        <th class="col-1">Resource Name</th>
        <th class="col-1">Reads</th>
        <th class="col-1">Updates</th>
        <th class="col-1">Published/Success</th>
        <th class="col-1">Published/Failure</th>
        <th class="col-1">Delete</th>
        <th class="col-1">Create</th>
        <th class="col-1">Users</th>
      </tr>
    </thead>
    <tbody *ngIf="audits.total > 0">
      <tr *ngFor="let audit of audits.results">
        <td>
          {{audit.fhirResource.resource.resourceType}}
        </td>
        <td>
          {{audit.fhirResource.resource.name}}
        </td>
        <td>
          {{audit.Reads}}
        </td>
        <td>
          {{audit.Updates}}
        </td>
        <td>
          {{audit.PublishSuccess}}
        </td>
        <td>
          {{audit.PublishFailure}}
        </td>
        <td>
          {{audit.Delete}}
        </td>
        <td>
          {{audit.Create}}
        </td>
        <td>
          <table class="table table-striped">
            <tr *ngFor="let user of audit.Users">
              <td>
                {{user}}
              </td>
            </tr>
          </table>
        </td>
        <td>
          <button type="button" class="btn btn-primary btn-sm" title="View raw audit" (click)="openRawModal(audit, 'View Audit')">
            <i class="fa fa-search"></i>
          </button>
        </td>

      </tr>
    </tbody>
    <tbody *ngIf="!loadingResults && audits.total === 0">
      <tr>
        <td colspan="6" class="text-center">No audits found matching the search criteria!</td>
      </tr>
    </tbody>
    <tbody *ngIf="loadingResults">
      <tr>
        <td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading audit logs</td>
      </tr>
    </tbody>
  </table>
  <table *ngIf = "reportType == 'fhirResourceReport'" class="table table-striped table-bordered">
    <thead>
    <tr>
      <th class="col-1"></th>
      <th class="col-3">Time</th>
      <th class="col-3">Report Type</th>
    </tr>
    <tr>
      <th></th>
      <th>
        <div class="row row-cols">
          <div class="col-6">
            <div class="dp-hidden position-absolute">
              <div class="input-group">
                <input name="datepicker" class="form-control" ngbDatepicker #datepicker="ngbDatepicker" [autoClose]="'outside'"
                       (dateSelect)="onDateSelection($event)" [displayMonths]="2" [dayTemplate]="t" outsideDays="hidden"
                       [startDate]="fromDate!" />
                <ng-template #t let-date let-focused="focused">
                    <span class="custom-day" [class.focused]="focused" [class.range]="isRange(date)"
                          [class.faded]="isHovered(date) || isInside(date)" (mouseenter)="hoveredDate = date"
                          (mouseleave)="hoveredDate = null">
                      {{ date.day }}
                    </span>
                </ng-template>
              </div>
            </div>
            <div class="input-group">
              <input #dpFromDate class="form-control" placeholder="yyyy-mm-dd" name="dpFromDate"
                     [value]="formatter.format(fromDate)"
                     (input)="fromDate = validateDateInput(fromDate, dpFromDate.value)" />
              <button type="button" class="btn btn-primary fa fa-times" (click)="fromDate=null"></button>
              <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
            </div>
          </div>
          <div class="col-6">
            <div class="input-group">
              <input #dpToDate class="form-control" placeholder="yyyy-mm-dd" name="dpToDate" [value]="formatter.format(toDate)"
                     (input)="toDate = validateDateInput(toDate, dpToDate.value)" />
              <button type="button" class="btn btn-primary fa fa-times" (click)="toDate=null"></button>
              <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
            </div>
          </div>
        </div>
      </th>
      <input type="text" class="form-control" [(ngModel)]="criteria.fhirResourceType" (ngModelChange)="criteriaChangedEvent.next()" />
    </tr>
    <tr>
      <th class="col-1">Resource Type</th>
      <th class="col-1">Resource Name</th>
      <th class="col-1">Reads</th>
      <th class="col-1">Updates</th>
      <th class="col-1">Delete</th>
      <th class="col-1">Create</th>
      <th class="col-1">Users</th>
    </tr>
    </thead>
    <tbody *ngIf="audits.total > 0">
    <tr *ngFor="let audit of audits.results">
      <td>
        {{audit.fhirResource.resource.resourceType}}
      </td>
      <td>
        {{audit.fhirResource.resource.name}}
      </td>
      <td>
        {{audit.Reads}}
      </td>
      <td>
        {{audit.Updates}}
      </td>
      <td>
        {{audit.Delete}}
      </td>
      <td>
        {{audit.Create}}
      </td>
      <td>
        <table class="table table-striped">
          <tr *ngFor="let user of audit.Users">
            <td>
              {{user}}
            </td>
          </tr>
        </table>
      </td>
      <td>
        <button type="button" class="btn btn-primary btn-sm" title="View raw audit" (click)="openRawModal(audit, 'View Audit')">
          <i class="fa fa-search"></i>
        </button>
      </td>

    </tr>
    </tbody>
    <tbody *ngIf="!loadingResults && audits.total === 0">
    <tr>
      <td colspan="6" class="text-center">No audits found matching the search criteria!</td>
    </tr>
    </tbody>
    <tbody *ngIf="loadingResults">
    <tr>
      <td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading audit logs</td>
    </tr>
    </tbody>
  </table>
  <table *ngIf = "reportType == 'usersReport'" class="table table-striped table-bordered">
    <thead>
    <tr>
      <th class="col-1"></th>
      <th class="col-3">Time</th>
    </tr>
    <tr>
      <th></th>
      <th>
        <div class="row row-cols">
          <div class="col-6">
            <div class="dp-hidden position-absolute">
              <div class="input-group">
                <input name="datepicker" class="form-control" ngbDatepicker #datepicker="ngbDatepicker" [autoClose]="'outside'"
                       (dateSelect)="onDateSelection($event)" [displayMonths]="2" [dayTemplate]="t" outsideDays="hidden"
                       [startDate]="fromDate!" />
                <ng-template #t let-date let-focused="focused">
                    <span class="custom-day" [class.focused]="focused" [class.range]="isRange(date)"
                          [class.faded]="isHovered(date) || isInside(date)" (mouseenter)="hoveredDate = date"
                          (mouseleave)="hoveredDate = null">
                      {{ date.day }}
                    </span>
                </ng-template>
              </div>
            </div>
            <div class="input-group">
              <input #dpFromDate class="form-control" placeholder="yyyy-mm-dd" name="dpFromDate"
                     [value]="formatter.format(fromDate)"
                     (input)="fromDate = validateDateInput(fromDate, dpFromDate.value)" />
              <button type="button" class="btn btn-primary fa fa-times" (click)="fromDate=null"></button>
              <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
            </div>
          </div>
          <div class="col-6">
            <div class="input-group">
              <input #dpToDate class="form-control" placeholder="yyyy-mm-dd" name="dpToDate" [value]="formatter.format(toDate)"
                     (input)="toDate = validateDateInput(toDate, dpToDate.value)" />
              <button type="button" class="btn btn-primary fa fa-times" (click)="toDate=null"></button>
              <button class="btn btn-primary fa fa-calendar" (click)="datepicker.toggle()" type="button"></button>
            </div>
          </div>
        </div>
      </th>
    </tr>
    <tr>
      <th class="col-1">Name</th>
      <th class="col-1">Email</th>
      <th class="col-1">Logins</th>
      <th class="col-1">Reads</th>
      <th class="col-1">Updates</th>
      <th class="col-1">Deletes</th>
      <th class="col-1">Creates</th>
      <th class="col-1">Publish Success</th>
      <th class="col-1">Publish Failure</th>
    </tr>
    </thead>
    <tbody *ngIf="audits.total > 0">
    <tr *ngFor="let audit of audits.results">
      <td>
        {{audit.username}}
      </td>
      <td>
        {{audit.email}}
      </td>
      <td>
        {{audit.Logins}}
      </td>
      <td>
        {{audit.Reads}}
      </td>
      <td>
        {{audit.Updates}}
      </td>
      <td>
        {{audit.Deletes}}
      </td>
      <td>
        {{audit.Creates}}
      </td>
      <td>
        {{audit.PublishSuccess}}
      </td>
      <td>
        {{audit.PublishFailure}}
      </td>
      <td>
        <button type="button" class="btn btn-primary btn-sm" title="View raw audit" (click)="openRawModal(audit, 'View Audit')">
          <i class="fa fa-search"></i>
        </button>
      </td>

    </tr>
    </tbody>
    <tbody *ngIf="!loadingResults && audits.total === 0">
    <tr>
      <td colspan="6" class="text-center">No audits found matching the search criteria!</td>
    </tr>
    </tbody>
    <tbody *ngIf="loadingResults">
    <tr>
      <td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading audit logs</td>
    </tr>
    </tbody>
  </table>
  <div class="d-flex justify-content-between" *ngIf="audits.total > 0" >
    <div>
      Total: {{ audits.total }}
    </div>

    <ngb-pagination class="d-flex justify-content-center" [pageSize]="audits.itemsPerPage" [collectionSize]="audits.total"
      [(page)]="currentPage" [boundaryLinks]="true" (pageChange)="getAudits()">
    </ngb-pagination>

    <div>
      <select id="itemsPerPage" class="form-select" [(ngModel)]="itemsPerPage" (ngModelChange)="criteriaChangedEvent.next()">
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
        <option [value]="100">100</option>
      </select>
    </div>
  </div>
</ng-container>

